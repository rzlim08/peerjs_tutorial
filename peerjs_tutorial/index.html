<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="index.css">
    <!-- import the webpage's javascript file -->
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script> 
        // Derived from: https://medium.com/samsung-internet-dev/building-an-internet-connected-phone-with-peerjs-775bd6ffebec
        const peer = new Peer(''+Math.floor(Math.random()*2**18).toString(36).padStart(4,0), {
        host: location.hostname,
        port:443,
        debug: 1,
        path: '/myapp'
        });
        window.peer = peer;
        peer.on('open', function () {
            window.caststatus.textContent = `Your device ID is: ${peer.id}`;
        });
        var conn; 
        function set_enter(){
            var chat = document.getElementById("chatSend");
            chat.addEventListener("keyup", function(event) {
                if(event.keyCode === 13) {
                    event.preventDefault();
                    sendChat();
                }
            })
        }
        function connectToPeer() {
            code = document.getElementById("myText").value; 
            conn = peer.connect(code);
            // on open will be launch when you successfully connect to PeerServer
            conn.on('open', function(){
            // here you have conn.id
                conn.send(peer.id);
                document.getElementById("connectedStatus").innerHTML = `Connected to: ${code}`;
                document.getElementById("connectedStatus").style.visibility = 'visible';
            });
            var call = peer.call(code, window.localStream);
            call.on('stream', function(stream){
                setRemoteStream(stream)
                showConnectedContent()
            })
            var chat = document.getElementById("chatSend");
            set_enter();
        }

        function sendChat() {
            var data = document.getElementById("chatSend").value
            conn.send(data)
            document.getElementById("chatArea").innerHTML += "<p class=\"alignRight\">" + data + "</p>"
            document.getElementById("chatSend").value = ""
        }
        peer.on('connection', function(msg_conn) {
            msg_conn.on('data', function(data){
                if(!conn){
                    document.getElementById("connectedStatus").innerHTML = `Connected to: ${data}`
                    document.getElementById("connectedStatus").style.visibility = 'visible';
                    conn = peer.connect(data);
                    conn.send(peer.id);
                    set_enter();
                }else{
                    document.getElementById("chatArea").innerHTML += "<p class=\"alignLeft\">" + data + "</p>"
                }
            });
        });
        peer.on('call', function(call) {
            const answerCall = confirm("Do you want to answer?")
            if(answerCall){
                showConnectedContent();
                call.answer(window.localStream)
                
                call.on('stream', function(stream) {
                    setRemoteStream(stream);
                });
                call.on('close', function (){
                    showCallContent();
                })
            } else {
                console.log("call denied");
            }
        });

        function setLocalStream(stream) {
                window.localVideo.srcObject = stream;
                window.localVideo.autoplay = true;
                window.localStream = stream;
        }
        function getLocalStream() {
                const constraints = {video: true, audio: true}

                navigator.mediaDevices.getUserMedia(constraints).then( stream => {
                        setLocalStream(stream);
                }).catch( err => {
                        console.log("u got an error:" + err)
                });
        }
        function setRemoteStream(stream) {
            window.remoteVideo.srcObject = stream;
            window.remoteVideo.autoplay = true;
            window.peerStream = stream;
        }
        function showConnectedContent() {
            document.querySelector('.call-container').hidden = false;
        }
        getLocalStream()

    </script>
    <title>Ryan's Sample PeerJS app!</title>
</head>
<body>
    <div class="pageContainer" style="display:flex;">
        <div class="chatPage">
            <div class="statuses">
                <p id="caststatus" class="big">
                    The peerjs id is ???
                </p> <p id="connectedStatus"></p>
                <br />
            </div>
            <input type="text" id="myText" placeholder="Enter remote id"><input class="conn-btn" type="submit" value="Connect" onclick="connectToPeer()">
            <div id="chatArea">
            </div>
            <textarea id="chatSend" placeholder="Enter text for chat" rows="4" cols="50"></textarea><input id="sendMessage" type="submit" value="Send" onclick="sendChat()">
        </div>
        <section class="call-container" hidden>
            <div class="audio-container">
                <p>You're automatically muted, unmute yourself!</p>
                <p> Remote </p>
                <video controls id="remoteVideo" muted="true" width=300 height=200></video>
                <p> You </p>
                <video id="localVideo" muted="true" width=300 height=200></video>
            </div>
            <button class="hangup-btn">
                Hang up
            </button>
        </section>
    </div>
    
</body>
</html>
